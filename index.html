<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Justin Workout</title>
<meta name="theme-color" content="#131a24" />
<style>
:root{
  --bg:#0c0f15;--panel:#131a24;--accent:#2ea043;--text:#e8eef5;--muted:#93a5b1;--border:#213043;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;font-family:-apple-system,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{padding:22px 16px 8px;background:linear-gradient(180deg,var(--panel),var(--bg))}
h1{margin:0;font-size:24px;letter-spacing:.3px}
.subtitle{margin:4px 0 0;color:var(--muted);font-size:13px}
nav{position:sticky;top:0;background:var(--bg);padding:8px 12px;border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;z-index:2}
.tab{padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:#0f1622;color:var(--text);font-weight:600;cursor:pointer}
.tab.active{outline:2px solid var(--accent)}
main{padding:16px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:14px}
.panel h2{margin:0 0 8px;font-size:18px}
.list{display:flex;flex-direction:column;gap:10px}
.item{background:#101826;border:1px solid var(--border);border-radius:12px;padding:12px}
.badge{background:var(--accent);color:#08140a;border-radius:10px;padding:2px 8px;font-weight:700;font-size:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,textarea,select{width:100%;background:#0e1622;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
input[type=number]{max-width:140px}
input[type=date]{max-width:200px}
.btn{border-radius:10px;padding:10px 14px;border:1px solid var(--border);background:#162233;color:var(--text);font-weight:600;cursor:pointer}
.btn:active{transform:scale(.98)}
.btn-ghost{background:transparent}
.progress{height:10px;background:#0e1622;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.progress>div{height:100%;background:var(--accent)}
table{width:100%;border-collapse:collapse}
td,th{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
footer{padding:16px;text-align:center;color:var(--muted)}
.svg{height:80px;border:1px solid var(--border);border-radius:10px;padding:6px;background:#0e1622}
.small{font-size:12px;color:#9bb0bf}
.chart{width:100%;height:220px;border:1px solid var(--border);border-radius:8px;background:#0e1622}
.ring{width:220px;height:220px;border:1px solid var(--border);border-radius:8px;background:#0e1622}
.card{background:#101826;border:1px solid var(--border);border-radius:12px;padding:12px}
.media{width:100%;max-width:560px;aspect-ratio:16/9;border:1px solid var(--border);border-radius:10px;background:#0e1622}
.imgDemo{width:100%;max-width:560px;border:1px solid var(--border);border-radius:10px;background:#0e1622;display:block}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:680px){.grid{grid-template-columns:1fr 1fr}}
.label{font-weight:700}
.tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:10px;margin-right:6px;color:#c9d7e1}
</style>
</head>
<body>
<header>
  <h1>Justin Workout</h1>
  <p class="subtitle">4-week plan • timers • 1-mile test • nutrition • weight trends • measurements</p>
</header>

<nav id="tabs">
  <button class="tab active" data-view="home">Home</button>
  <button class="tab" data-view="today">Today</button>
  <button class="tab" data-view="week">This Week</button>
  <button class="tab" data-view="log">History</button>
  <button class="tab" data-view="weight">Weight</button>
  <button class="tab" data-view="nutrition">Nutrition</button>
  <button class="tab" data-view="directory">Directory</button>
  <button class="tab" data-view="seated">Seated</button>
  <button class="tab" data-view="measure">Measurements</button>
  <button class="tab" data-view="notes">Notes</button>
  <button class="tab" data-view="test">1-Mile Test</button>
  <button class="tab" data-view="settings">Settings</button>
</nav>

<main id="view"></main>
<footer>© 2025 Justin — PWA</footer>

<script>
/* ===================== DATA ===================== */
const EXERCISES = [
  {id:"warm_walk",name:"5–10 min Easy Walk",type:"warmup",
   how:"Walk at a pace that raises breathing but allows nasal breathing. Shoulders relaxed.",
   cues:["Head tall","Soft steps"],equipment:"none",
   svg:"<svg viewBox='0 0 200 120' xmlns='http://www.w3.org/2000/svg'><g fill='none' stroke='white' stroke-width='4'><circle cx='100' cy='20' r='10'/><path d='M100 30 v25'/><path d='M100 55 l-18 22'/><path d='M100 55 l18 18'/></g></svg>"
  },
  {id:"band_row",name:"Seated Band Row (Neutral)",type:"strength",
   how:"Anchor band at foot level. Sit tall. Pull to ribs, 1s pause, slow return.",
   cues:["Elbows ~45°","No shrug"],equipment:"band",
   svg:"<svg viewBox='0 0 200 120' xmlns='http://www.w3.org/2000/svg'><g fill='none' stroke='white' stroke-width='4'><circle cx='60' cy='30' r='10'/><path d='M60 40 v25'/><path d='M80 75 l60 0' stroke='#2ea043'/></g></svg>"
  },
  {id:"plank_knees",name:"Plank (On Knees)",type:"core",
   how:"Forearms on floor, knees down, ribs tucked. Quiet nasal breathing.",
   cues:["Back flat","Elbows under shoulders"],equipment:"mat",
   svg:"<svg viewBox='0 0 200 120' xmlns='http://www.w3.org/2000/svg'><g fill='none' stroke='white' stroke-width='4'><path d='M20 70 l60 0'/><path d='M80 70 l50 -20'/></g></svg>"
  },
  {id:"glute_bridge",name:"Glute Bridge",type:"strength",
   how:"Lie on back, knees bent. Drive heels, squeeze glutes to lift hips. Pause, slow lower.",
   cues:["Ribs down","No back arch"],equipment:"mat",
   svg:"<svg viewBox='0 0 200 120' xmlns='http://www.w3.org/2000/svg'><g fill='none' stroke='white' stroke-width='4'><path d='M20 90 h60'/><path d='M80 90 q30 -30 60 0'/></g></svg>"
  },
  {id:"push_up_elev",name:"Incline Push-Up",type:"strength",
   how:"Hands on counter/bench, body straight. Lower with control, press away.",
   cues:["Elbows 30–45°","Squeeze glutes"],equipment:"counter",
   svg:"<svg viewBox='0 0 200 120' xmlns='http://www.w3.org/2000/svg'><g fill='none' stroke='white' stroke-width='4'><path d='M20 90 h60'/><path d='M80 90 l60 -30'/><circle cx='140' cy='60' r='8'/></g></svg>"
  }
];

/* Directory DB (real media). Add your own items or replace links. */
const ACTIVITY_DB = [
  // WARM-UP
  {
    id:"wu_arm_circles", name:"Arm Circles", category:"warmup",
    how:"Stand tall; circle arms forward/back 10–20 reps each.",
    cues:["Ribs down","Easy range"], 
    img:"https://images.unsplash.com/photo-1599058917212-d750089bc07d?q=80&w=1200&auto=format&fit=crop",
    video:"https://www.youtube.com/watch?v=Y7xW8y3XQ0o"
  },
  {
    id:"wu_cat_cow", name:"Cat–Cow", category:"warmup",
    how:"On hands/knees, alternate rounding and extending spine for 8–12 reps.",
    cues:["Slow breathe","No pinching"],
    img:"https://images.unsplash.com/photo-1599058898302-df2f8b16d2bf?q=80&w=1200&auto=format&fit=crop",
    video:""
  },

  // COOLDOWN
  {
    id:"cd_box_breath", name:"Box Breathing (4-4-4-4)", category:"cooldown",
    how:"Inhale 4 • Hold 4 • Exhale 4 • Hold 4. Repeat 4–8 rounds.",
    cues:["Quiet nose breathing","Relax jaw/shoulders"],
    img:"",
    video:"https://www.youtube.com/watch?v=F28MGLlpP90"
  },

  // SEATED / DESK
  {
    id:"seat_ankle_circles", name:"Seated Ankle Circles", category:"seated",
    how:"Sit tall. Circle ankles 10x each direction per side.",
    cues:["Knee still","Smooth motion"],
    img:"https://images.unsplash.com/photo-1550525811-e5869dd03032?q=80&w=1200&auto=format&fit=crop",
    video:""
  },
  {
    id:"seat_pull_aparts", name:"Seated Band Pull-Apart", category:"seated",
    how:"Hold band at chest height; pull ends apart, pause, slow return. 2–3×12.",
    cues:["Ribs down","No shrug"],
    img:"",
    video:"https://www.youtube.com/watch?v=K6w5kS8QwVY"
  },
  {
    id:"seat_neck", name:"Seated Neck Rotations", category:"seated",
    how:"Rotate head left/right gently; 5–8 reps each side.",
    cues:["Stay tall","No forcing end range"],
    img:"",
    video:""
  }
];

const PLAN = {
 weeks:[
  {id:1, objective:"Rebuild shoulder control & core—pain-free range, easy volume.",
   sessions:[
    {day:"Mon",items:[["warm_walk",1,"8 min"],["band_row",3,"10"],["plank_knees",3,"20–30s"],["glute_bridge",3,"12"]]},
    {day:"Tue",items:[["warm_walk",1,"10 min"],["plank_knees",3,"20–30s"],["glute_bridge",3,"12"]]},
    {day:"Thu",items:[["warm_walk",1,"8 min"],["band_row",3,"10"],["plank_knees",3,"30s"],["glute_bridge",3,"12"]]},
    {day:"Sat",items:[["warm_walk",1,"12 min"],["push_up_elev",2,"6 (pain-free)"]]}
   ]
  },
  {id:2, objective:"Add gentle pressing & longer holds; keep everything pain-free.",
   sessions:[
    {day:"Mon",items:[["warm_walk",1,"8–10 min"],["band_row",3,"12"],["push_up_elev",3,"6–8"],["plank_knees",3,"35–40s"]]},
    {day:"Wed",items:[["warm_walk",1,"10 min"],["glute_bridge",3,"14"],["plank_knees",3,"35–40s"]]},
    {day:"Fri",items:[["warm_walk",1,"8–10 min"],["band_row",3,"12"],["push_up_elev",3,"8–10"],["plank_knees",3,"40s"]]}
   ]
  },
  {id:3, objective:"Progress volume; add tempo on pushes/rows.",
   sessions:[
    {day:"Mon",items:[["warm_walk",1,"8–12 min"],["band_row",4,"10 (2s pause)"],["push_up_elev",4,"8–10 (3s down)"],["glute_bridge",3,"16"]]},
    {day:"Wed",items:[["warm_walk",1,"10 min"],["plank_knees",3,"45–50s"],["glute_bridge",3,"16"]]},
    {day:"Sat",items:[["warm_walk",1,"20 min brisk"],["band_row",3,"AMRAP-2"],["push_up_elev",3,"AMRAP-2"]]}
   ]
  },
  {id:4, objective:"Consolidate & test—optional standard plank; longer walk.",
   sessions:[
    {day:"Mon",items:[["warm_walk",1,"10–12 min"],["band_row",4,"12"],["push_up_elev",4,"10"],["plank_knees",3,"50–60s"]]},
    {day:"Wed",items:[["warm_walk",1,"25 min"],["glute_bridge",3,"18"],["plank_knees",3,"50–60s"]]},
    {day:"Fri",items:[["warm_walk",1,"20 min"],["push_up_elev",3,"AMRAP-2"],["band_row",3,"AMRAP-2"],["plank_knees",1,"Max hold"]]}
   ]
  }
 ]
};

const FOODS = [
 {name:"Egg (large)",unit:"1 egg",kcal:72,protein:6,carbs:0.4,fat:5},
 {name:"PBfit (2 Tbsp)",unit:"2 Tbsp",kcal:70,protein:8,carbs:4,fat:2},
 {name:"Oatmeal (dry, 40g)",unit:"40 g",kcal:150,protein:5,carbs:27,fat:3},
 {name:"Pizza slice (cheese)",unit:"1 slice",kcal:285,protein:12,carbs:36,fat:10},
 {name:"Tortilla (flour)",unit:"1 tortilla",kcal:160,protein:4,carbs:26,fat:4},
 {name:"Bagel (plain)",unit:"1 bagel",kcal:275,protein:10,carbs:55,fat:2},
 {name:"English muffin",unit:"1 muffin",kcal:130,protein:5,carbs:25,fat:1},
 {name:"Cheddar (28g)",unit:"28 g",kcal:113,protein:7,carbs:0.4,fat:9},
 {name:"Ground beef 80/20 (100g)",unit:"100 g",kcal:254,protein:17,carbs:0,fat:20}
];

/* ===================== HELPERS ===================== */
const $ = sel => document.querySelector(sel);
const view = $("#view");
const todayISO = () => new Date().toISOString().slice(0,10);
const ls = (k,v) => (v===undefined? JSON.parse(localStorage.getItem(k)||"null") : localStorage.setItem(k, JSON.stringify(v)));

function getWeekIndex() {
  const startISO = ls("startDateISO") || new Date().toISOString();
  if (!ls("startDateISO")) ls("startDateISO", startISO);
  const start = new Date(startISO), today = new Date();
  const diff = Math.floor((today - start)/(1000*60*60*24));
  return Math.min(3, Math.floor(diff/7));
}
function weekdayName(d){return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d];}
function isoOffset(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }

/* ===================== VIEWS ===================== */
const VIEWS = {
 home(){
   view.innerHTML = `
     <section class="panel"><h2>Welcome</h2>
       <p>Tap a tab above. Try <strong>Today</strong> to log a session, <strong>Nutrition</strong> for the ring, or <strong>Weight</strong> to track trends.</p>
     </section>
     <section class="panel grid">
       <div class="card">
         <h3>Quick Add</h3>
         <div class="row">
           <button class="btn" data-go="today">Today's Workout</button>
           <button class="btn" data-go="nutrition">Nutrition</button>
           <button class="btn" data-go="weight">Weight</button>
         </div>
       </div>
       <div class="card">
         <h3>This Week Objective</h3>
         <p class="small">${PLAN.weeks[getWeekIndex()].objective}</p>
       </div>
     </section>`;
   view.querySelectorAll("[data-go]").forEach(b=>b.onclick=()=>switchView(b.dataset.go));
 },

 today(){
  const w = PLAN.weeks[getWeekIndex()];
  const dow = weekdayName(new Date().getDay());
  const session = (w.sessions||[]).find(s=>s.day===dow);
  let html = `<section class="panel"><h2>Planned Items</h2>`;
  if (!session) {
    html += `<p>No planned session today. Add notes and save if you did anything.</p></section>`;
  } else {
    html += `<div id="todayList" class="list">` +
      session.items.map(it=>{
        const ex = EXERCISES.find(e=>e.id===it[0]);
        const name = ex? ex.name : it[0];
        return `<div class="item">
          <div><strong>${name}</strong> <span class="badge">${it[2]||""}</span></div>
          <div class="row">
            <input type="number" placeholder="Sets" min="0" />
            <input type="text" placeholder="Reps/Time" />
            <input type="checkbox" title="Done" />
          </div>
        </div>`;
      }).join("") + `</div></section>`;
  }
  html += `
    <section class="panel"><h2>Timer</h2>
      <div class="row">
        <input id="timerSec" type="number" placeholder="Seconds" />
        <button class="btn" id="startTimer">Start</button>
        <button class="btn" id="stopTimer">Stop</button>
      </div>
      <h3 id="countdown">00:00</h3>
    </section>
    <section class="panel"><h2>Notes</h2>
      <textarea id="notes" rows="4" placeholder="How did it feel? Pain 0–10?"></textarea>
      <div style="height:8px"></div>
      <button class="btn" id="saveBtn">Save Session</button>
    </section>`;
  view.innerHTML = html;

  $("#saveBtn").onclick = ()=>{
    const list = [...document.querySelectorAll("#todayList .item")];
    const data = list.map(el=>{
      const title = el.querySelector("strong").textContent;
      const target = (el.querySelector(".badge")||{textContent:""}).textContent;
      const [sets,reps,done] = el.querySelectorAll("input");
      return {title,target,sets:sets.value,reps:reps.value,done:done.checked};
    });
    const entry = {date: todayISO(), data, notes: $("#notes").value};
    const log = ls("log") || [];
    const i = log.findIndex(x=>x.date===entry.date);
    if (i>=0) log[i]=entry; else log.push(entry);
    ls("log", log);
    alert("Saved ✅");
  };

  let t=null, remaining=0;
  const cd=$("#countdown");
  const fmt=s=>{s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), ss=String(s%60).padStart(2,"0"); return `${m}:${ss}`};
  $("#startTimer").onclick=()=>{
    const sec=parseInt($("#timerSec").value||"0"); if(!sec) return;
    remaining=sec; cd.textContent=fmt(remaining);
    if(t) clearInterval(t);
    t=setInterval(()=>{ remaining--; cd.textContent=fmt(remaining); if(remaining<=0){ clearInterval(t); alert("Time!"); } },1000);
  };
  $("#stopTimer").onclick=()=>{ if(t) clearInterval(t); };
 },

 week(){
   const w = PLAN.weeks[getWeekIndex()];
   let html = `<section class="panel"><h2>This Week</h2><p class="small">${w.objective}</p><div class="list">`;
   w.sessions.forEach(s=>{
     html += `<div class="item"><strong>${s.day}</strong><ul style="margin:8px 0 0 18px">` +
       s.items.map(it=>`<li>${it[0]} — <span class="badge">${it[2]||""}</span></li>`).join("") +
       `</ul></div>`;
   });
   html += `</div></section>`;
   view.innerHTML = html;
 },

 log(){
  const log = (ls("log")||[]).sort((a,b)=>a.date.localeCompare(b.date));
  let html = `<section class="panel"><h2>History</h2><div class="list">`;
  if (!log.length) html += `<div class="item">No sessions saved yet.</div>`;
  log.forEach(entry=>{
    const doneCount = (entry.data||[]).filter(x=>x.done).length + "/" + (entry.data||[]).length;
    html += `<div class="item"><strong>${entry.date}</strong><div>${doneCount} items done</div><div>${entry.notes||""}</div></div>`;
  });
  html += `</div></section><section class="panel"><h2>Streak</h2><p id="streak">0 days</p></section>`;
  view.innerHTML = html;

  const today = new Date(); today.setHours(0,0,0,0);
  let streak=0;
  for(let i=0;i<365;i++){
    const dt=new Date(); dt.setDate(today.getDate()-i); const ds=dt.toISOString().slice(0,10);
    const did=(ls("log")||[]).some(x=>x.date===ds && (x.data||[]).some(y=>y.done));
    if (did) streak++; else break;
  }
  $("#streak").textContent = `${streak} day streak`;
 },

 /* ---------- WEIGHT (keeps starting weight; 3-month window; backfill/edit) ---------- */
 weight(){
  const weights = ls("weights")||[]; // [{date:'YYYY-MM-DD', val:Number}]
  if (!ls("startWeight") && weights.length) ls("startWeight", weights[0].val);

  view.innerHTML = `
    <section class="panel"><h2>Weight</h2>
      <div class="row">
        <input id="wtDate" type="date" value="${todayISO()}">
        <input id="wtVal" type="number" step="0.1" placeholder="Weight (lbs or kg)">
        <button class="btn" id="saveWt">Save</button>
      </div>
      <p class="small">Backfill by choosing a past date. Your first saved weight is kept as the baseline.</p>
    </section>
    <section class="panel"><h2>Trend (last 3 months)</h2>
      <canvas id="wtChart" class="chart"></canvas>
      <div id="wtStats" class="small" style="margin-top:8px"></div>
    </section>
    <section class="panel"><h2>History</h2>
      <div id="wtList" class="list"></div>
    </section>
  `;

  $("#saveWt").onclick = ()=>{
    const d = $("#wtDate").value || todayISO();
    const v = parseFloat($("#wtVal").value);
    if (!v) return alert("Enter a number first.");
    const arr = ls("weights") || [];
    const idx = arr.findIndex(x=>x.date===d);
    if (idx>=0) arr[idx].val = v; else arr.push({date:d, val:v});
    arr.sort((a,b)=>a.date.localeCompare(b.date));
    ls("weights", arr);
    if (!ls("startWeight")) ls("startWeight", v);
    render();
    alert("Saved ✅");
  };

  function render(){
    const arr = (ls("weights")||[]).sort((a,b)=>a.date.localeCompare(b.date));
    const startW = ls("startWeight") ?? (arr[0]?.val ?? null);

    const end = new Date(); const start = new Date(); start.setMonth(end.getMonth()-3);
    const windowArr = arr.filter(x=> new Date(x.date) >= start);

    const list = $("#wtList"); list.innerHTML="";
    (arr.length?arr:[]).forEach((x,i)=>{
      const el=document.createElement("div"); el.className="item";
      el.innerHTML = `<div class="row">
        <strong style="min-width:110px">${x.date}</strong>
        <input type="number" step="0.1" value="${x.val}" data-i="${i}" style="max-width:120px">
        <button class="btn btn-ghost" data-del="${i}">Delete</button>
      </div>`;
      list.append(el);
    });
    list.querySelectorAll("input[type=number]").forEach(inp=>{
      inp.onchange=()=>{ const i=+inp.dataset.i; const arr=ls("weights")||[]; arr[i].val=parseFloat(inp.value); ls("weights",arr); draw(startW); };
    });
    list.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick=()=>{ const i=+btn.dataset.del; const arr=ls("weights")||[]; arr.splice(i,1); ls("weights",arr);
        if (i===0){ const a2=ls("weights")||[]; ls("startWeight", a2.length? a2[0].val : null); }
        render();
      };
    });

    const last = windowArr[windowArr.length-1]?.val;
    const weekAgo = arr.find(x=>x.date===isoOffset(-7));
    const delta7 = (last!=null && weekAgo)? (last-weekAgo.val).toFixed(1) : null;
    $("#wtStats").textContent = [
      startW!=null?`Start: ${startW}`:null,
      last!=null?`Current: ${last}`:null,
      (delta7!=null)?`7-day change: ${delta7}`:null
    ].filter(Boolean).join(" • ");

    draw(startW);
  }

  function draw(startW){
    const c=$("#wtChart"), ctx=c.getContext("2d");
    const W=c.width=c.clientWidth, H=c.height=c.clientHeight;
    ctx.clearRect(0,0,W,H);

    const all=(ls("weights")||[]).sort((a,b)=>a.date.localeCompare(b.date));
    const end=new Date(); const start=new Date(); start.setMonth(end.getMonth()-3);
    const arr=all.filter(x=> new Date(x.date)>=start);
    if (arr.length<2){ ctx.fillStyle="#9bb0bf"; ctx.fillText("Add a few entries to see the trend.",12,24); return; }

    const vals=arr.map(x=>x.val);
    const avg7=vals.map((_,i)=>{ const s=Math.max(0,i-6), sl=vals.slice(s,i+1); return sl.reduce((a,b)=>a+b,0)/sl.length; });

    const min=Math.min(...vals,...avg7), max=Math.max(...vals,...avg7);
    const pad=(max-min)*0.1 || 1, yMin=min-pad, yMax=max+pad;
    const xStep=W/Math.max(1,arr.length-1), y=v=>H-((v-yMin)/(yMax-yMin))*H;

    ctx.strokeStyle="#213043"; ctx.lineWidth=1;
    for(let i=1;i<5;i++){ const yy=(H/5)*i; ctx.beginPath(); ctx.moveTo(0,yy); ctx.lineTo(W,yy); ctx.stroke(); }

    ctx.strokeStyle="#e8eef5"; ctx.lineWidth=2; ctx.beginPath();
    arr.forEach((p,i)=>{ const x=i*xStep, yy=y(p.val); i?ctx.lineTo(x,yy):ctx.moveTo(x,yy); });
    ctx.stroke();

    ctx.strokeStyle="#2ea043"; ctx.lineWidth=2; ctx.beginPath();
    avg7.forEach((v,i)=>{ const x=i*xStep, yy=y(v); i?ctx.lineTo(x,yy):ctx.moveTo(x,yy); });
    ctx.stroke();

    if (startW!=null){
      ctx.strokeStyle="#7f95a6"; ctx.setLineDash([6,4]); ctx.beginPath();
      const yy=y(startW); ctx.moveTo(0,yy); ctx.lineTo(W,yy); ctx.stroke(); ctx.setLineDash([]);
    }
  }

  render();
 },

 /* ---------- NUTRITION with MACRO RING + CRONOMETER IMPORT ---------- */
 nutrition(){
  const s = ls("settings")||{kcal:2400, protein:180};
  const kcalGoal=s.kcal||2400, proteinGoal=s.protein||180;

  view.innerHTML = `
    <section class="panel"><h2>Today</h2>
      <div class="progress"><div id="kcalBar" style="width:0%"></div></div>
      <div class="row"><div><strong id="kcalNow">0</strong> / <span>${kcalGoal}</span> kcal</div>
      <div><strong id="proteinNow">0</strong> / <span>${proteinGoal}</span> g protein</div></div>
    </section>
    <section class="panel grid">
      <div>
        <h2>Nutrition Ring</h2>
        <canvas id="macroRing" class="ring"></canvas>
        <p class="small" id="macroText">P 0g • C 0g • F 0g</p>
      </div>
      <div>
        <h2>Add Food</h2>
        <input id="q" placeholder="Search: egg, oatmeal, pizza">
        <div id="results" class="list"></div>
      </div>
    </section>
    <section class="panel"><h2>Log</h2>
      <table><thead><tr><th>Food</th><th>Qty</th><th>kcal</th><th>P</th><th>C</th><th>F</th><th></th></tr></thead>
      <tbody id="logBody"></tbody></table>
    </section>
    <section class="panel"><h2>Add Custom Food</h2>
      <div class="row">
        <input id="cName" placeholder="Name">
        <input id="cQty" type="number" placeholder="serving size">
        <input id="cK" type="number" placeholder="kcal">
        <input id="cP" type="number" placeholder="P">
        <input id="cC" type="number" placeholder="C">
        <input id="cF" type="number" placeholder="F">
        <button class="btn" id="addCustom">Save</button>
      </div>
      <p class="small">Tip: Add your common meals here once, then reuse them fast.</p>
    </section>
    <section class="panel">
      <h2>Import from Cronometer (CSV)</h2>
      <p class="small">Cronometer → Settings → Account → <b>Export Data</b> → Export <b>Diary</b> or <b>Servings</b> as CSV. Then import it here.</p>
      <div class="row">
        <input id="cronoFile" type="file" accept=".csv">
        <button class="btn" id="cronoImport">Import CSV</button>
      </div>
    </section>`;

  function totals(){
    const log=ls("foodLog")||{}; const day=log[todayISO()]||[];
    return day.reduce((acc,x)=>({k:acc.k+x.kcal, p:acc.p+x.protein, c:acc.c+x.carbs, f:acc.f+x.fat}),{k:0,p:0,c:0,f:0});
  }
  function renderTotals(){
    const t=totals(); $("#kcalNow").textContent=Math.round(t.k); $("#proteinNow").textContent=Math.round(t.p);
    $("#kcalBar").style.width = Math.min(100, Math.round((t.k/Math.max(1,kcalGoal))*100)) + "%";
    const tbody=$("#logBody"); const log=ls("foodLog")||{}; const day=log[todayISO()]||[]; tbody.innerHTML="";
    day.forEach((x,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${x.name}</td><td>${x.qty}</td><td>${Math.round(x.kcal)}</td><td>${Math.round(x.protein)}</td><td>${Math.round(x.carbs)}</td><td>${Math.round(x.fat)}</td><td><button data-i="${i}" class="btn btn-ghost">✕</button></td>`;
      tbody.append(tr);
    });
    tbody.querySelectorAll("button[data-i]").forEach(b=>b.onclick=()=>{ const log=ls("foodLog")||{}; const day=log[todayISO()]||[]; day.splice(+b.dataset.i,1); log[todayISO()]=day; ls("foodLog",log); renderTotals(); drawRing(); });
    $("#macroText").textContent = `P ${Math.round(t.p)}g • C ${Math.round(t.c)}g • F ${Math.round(t.f)}g`;
  }
  function addFood(it, qty){
    const log=ls("foodLog")||{}; const day=log[todayISO()]||[]; const q=Number(qty)||1;
    day.push({name:it.name, qty:q, kcal:it.kcal*q, protein:it.protein*q, carbs:it.carbs*q, fat:it.fat*q});
    log[todayISO()]=day; ls("foodLog", log); renderTotals(); drawRing();
  }
  function drawRing(){
    const t=totals(); const sum=Math.max(1, t.p+t.c+t.f);
    const c=$("#macroRing"), ctx=c.getContext("2d"); const W=c.width=c.clientWidth, H=c.height=c.clientHeight, R=Math.min(W,H)/2-12;
    ctx.clearRect(0,0,W,H); const cx=W/2, cy=H/2; const parts=[{v:t.p,label:"P",col:"#e8eef5"},{v:t.c,label:"C",col:"#2ea043"},{v:t.f,label:"F",col:"#7f95a6"}];
    let a0=-Math.PI/2; parts.forEach(p=>{ const ang=(p.v/sum)*Math.PI*2; ctx.beginPath(); ctx.strokeStyle=p.col; ctx.lineWidth=24; ctx.arc(cx,cy,R,a0,a0+ang); ctx.stroke(); a0+=ang; });
    ctx.beginPath(); ctx.fillStyle="#0e1622"; ctx.arc(cx,cy,R-20,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#c9d7e1"; ctx.textAlign="center"; ctx.font="14px system-ui"; ctx.fillText("Macros", cx, cy-6);
    ctx.font="18px system-ui"; ctx.fillText(`${Math.round(t.p)}/${Math.round(sum)} g P`, cx, cy+18);
  }

  $("#q").oninput = e=>{
    const q=e.target.value.toLowerCase().trim(); const res=$("#results"); res.innerHTML="";
    if(!q) return;
    FOODS.filter(f=>f.name.toLowerCase().includes(q)).slice(0,20).forEach(it=>{
      const el=document.createElement("div"); el.className="item";
      el.innerHTML = `<div><strong>${it.name}</strong> <span class="badge">per ${it.unit}</span>
        <div class="small">kcal ${it.kcal} • P ${it.protein} • C ${it.carbs} • F ${it.fat}</div></div>
        <div class="row"><input type="number" placeholder="Qty" value="1" style="max-width:90px"><button class="btn">Add</button></div>`;
      const qty = el.querySelector("input");
      el.querySelector("button").onclick = ()=>addFood(it, qty.value);
      res.append(el);
    });
  };
  $("#addCustom").onclick = ()=>{
    const name=$("#cName").value||"Custom", unit=$("#cQty").value||"1";
    const K=+($("#cK").value||0), P=+($("#cP").value||0), C=+($("#cC").value||0), F=+($("#cF").value||0);
    addFood({name,unit,kcal:K,protein:P,carbs:C,fat:F},1);
    ["cName","cQty","cK","cP","cC","cF"].forEach(id=>$("#"+id).value="");
  };

  // Cronometer CSV import
  $("#cronoImport").onclick = async ()=>{
    const f = $("#cronoFile").files?.[0];
    if(!f) return alert("Choose a Cronometer CSV file first.");
    const text = await f.text();
    const rows = text.split(/\r?\n/).filter(x=>x.trim().length);
    const header = rows.shift().split(",").map(h=>h.replace(/^"|"$/g,"").trim().toLowerCase());

    const idx = name=>header.findIndex(h=>h.includes(name));
    const iDate = idx("time")>=0? idx("time") : idx("date");
    const iFood = idx("food")>=0? idx("description") : -1;
    const iKcal = (idx("energy (kcal)")>=0? idx("energy (kcal)") : idx("calories"));
    const iP = idx("protein");
    const iC = (idx("carb")>=0? idx("carb") : idx("carbo"));
    const iF = idx("fat");

    if (iDate<0 || iFood<0) return alert("Couldn’t find Date/Food columns in this CSV.");

    const log = ls("foodLog")||{};
    rows.forEach(line=>{
      const cols = splitCSV(line);
      const dateRaw = (cols[iDate]||"").replace(/^"|"$/g,"");
      const dateISO = toDateISO(dateRaw);
      if(!dateISO) return;
      const item = {
        name: (cols[iFood]||"Food").replace(/^"|"$/g,""),
        qty: 1,
        kcal: +((cols[iKcal]||"0").replace(/[^0-9.\-]/g,"")) || 0,
        protein: +((cols[iP]||"0").replace(/[^0-9.\-]/g,"")) || 0,
        carbs: +((cols[iC]||"0").replace(/[^0-9.\-]/g,"")) || 0,
        fat: +((cols[iF]||"0").replace(/[^0-9.\-]/g,"")) || 0
      };
      log[dateISO] = log[dateISO]||[];
      log[dateISO].push(item);
    });
    ls("foodLog", log);
    alert("Cronometer data imported ✅  Open each date to verify.");
    renderTotals(); drawRing();
  };

  function splitCSV(str){
    const out=[]; let cur="", q=false;
    for(let i=0;i<str.length;i++){
      const ch=str[i];
      if(ch==='"' ){ q=!q; continue; }
      if(ch===',' && !q){ out.push(cur); cur=""; continue; }
      cur+=ch;
    }
    out.push(cur);
    return out;
  }
  function toDateISO(s){
    s = s.trim();
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
    const m = s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if (m){
      const mm = m[1].padStart(2,'0'), dd = m[2].padStart(2,'0');
      const yyyy = m[3].length===2 ? ('20'+m[3]) : m[3];
      return `${yyyy}-${mm}-${dd}`;
    }
    const d = new Date(s); if(!isNaN(d)) return d.toISOString().slice(0,10);
    return null;
  }

  renderTotals(); drawRing();
 },

 /* ---------- DIRECTORY (real images/videos + search) ---------- */
 directory(){
  view.innerHTML = `
    <section class="panel"><h2>Directory</h2>
      <div class="row">
        <input id="dSearch" placeholder="Search activities…">
        <select id="dFilter">
          <option value="">All</option>
          <option value="warmup">Warm-up</option>
          <option value="strength">Workout</option>
          <option value="core">Workout (core)</option>
          <option value="cooldown">Cooldown</option>
          <option value="seated">Seated</option>
        </select>
      </div>
    </section>
    <section class="panel"><div id="dList" class="list"></div></section>
    <section class="panel"><h2>Add your own media</h2>
      <p class="small">Edit <b>ACTIVITY_DB</b> at the top. Use <code>img</code> for a photo, and <code>video</code> for a YouTube or MP4 link.</p>
    </section>
  `;
  function matches(q, item){
    q=q.toLowerCase();
    return !q || item.name.toLowerCase().includes(q) || (item.how||"").toLowerCase().includes(q) || (item.cues||[]).join(" ").toLowerCase().includes(q);
  }
  function embedVideo(url){
    if (!url) return "";
    if (/youtube\.com|youtu\.be/.test(url)){
      const id = (url.match(/(?:v=|be\/)([A-Za-z0-9_\-]+)/)||[])[1] || "";
      return `<div class="media" style="margin-top:10px"><iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe></div>`;
    }
    return `<video class="media" style="margin-top:10px" src="${url}" controls></video>`;
  }
  function render(){
    const q=$("#dSearch").value||""; const f=$("#dFilter").value||"";
    const base=[...EXERCISES.map(x=>({id:x.id,name:x.name,category:x.type,how:x.how,cues:x.cues,svg:x.svg,img:"",video:""})),...ACTIVITY_DB];
    const list=$("#dList"); list.innerHTML="";
    base.filter(x=>matches(q,x) && (!f || x.category===f)).forEach(x=>{
      const media = x.img ? `<img class="imgDemo" src="${x.img}" alt="">`
                 : x.svg ? `<div class="svg">${x.svg}</div>` : "";
      const vid = embedVideo(x.video);
      const el=document.createElement("div"); el.className="item";
      el.innerHTML = `
        <div class="row" style="align-items:start;gap:12px">
          <div style="flex:1;min-width:220px">
            <div><strong>${x.name}</strong> <span class="tag">${x.category||"activity"}</span></div>
            <div class="small" style="margin-top:6px">${x.how||""}</div>
            <div class="small" style="margin-top:6px">${(x.cues||[]).map(c=>"• "+c).join("<br>")}</div>
          </div>
          <div style="flex:1;min-width:240px">${media}${vid}</div>
        </div>`;
      list.append(el);
    });
  }
  $("#dSearch").oninput=render; $("#dFilter").onchange=render; render();
 },

 /* ---------- SEATED view ---------- */
 seated(){
  view.innerHTML = `
    <section class="panel"><h2>Seated / Desk Drills</h2>
      <p class="small">Great while working at a computer or watching TV. Aim for 2–5 minutes each hour.</p>
      <div class="row"><input id="sSearch" placeholder="Search seated drills…"></div>
    </section>
    <section class="panel"><div id="sList" class="list"></div></section>
  `;
  function render(){
    const q=$("#sSearch").value?.toLowerCase()||"";
    const items = ACTIVITY_DB.filter(x=>x.category==="seated" && (!q || x.name.toLowerCase().includes(q) || (x.how||"").toLowerCase().includes(q)));
    const list=$("#sList"); list.innerHTML="";
    if(!items.length){ list.innerHTML = `<div class="item">No seated drills yet.</div>`; return; }
    items.forEach(x=>{
      const media = x.img ? `<img class="imgDemo" src="${x.img}" alt="">` : "";
      const vid = x.video ? (/youtu/.test(x.video)
        ? `<div class="media" style="margin-top:10px"><iframe width="100%" height="100%" src="https://www.youtube.com/embed/${(x.video.match(/(?:v=|be\/)([A-Za-z0-9_\-]+)/)||[])[1]||""}" frameborder="0" allowfullscreen></iframe></div>`
        : `<video class="media" style="margin-top:10px" src="${x.video}" controls></video>`) : "";
      const el=document.createElement("div"); el.className="item";
      el.innerHTML = `<div><strong>${x.name}</strong></div><div class="small" style="margin-top:6px">${x.how||""}</div>${media}${vid}`;
      list.append(el);
    });
  }
  $("#sSearch").oninput=render; render();
 },

 /* ---------- MEASUREMENTS with crisp body diagram ---------- */
 measure(){
  view.innerHTML = `
    <section class="panel grid">
      <div>
        <h2>Measurements</h2>
        <div class="row">
          <input id="mDate" type="date" value="${todayISO()}">
          <button class="btn" id="saveM">Save</button>
        </div>
        <div class="kv" style="margin-top:8px">
          <label>Neck</label><input id="mNeck" type="number" step="0.1" placeholder="in">
          <label>Chest</label><input id="mChest" type="number" step="0.1" placeholder="in">
          <label>Waist</label><input id="mWaist" type="number" step="0.1" placeholder="in">
          <label>Hips</label><input id="mHips" type="number" step="0.1" placeholder="in">
          <label>Thigh</label><input id="mThigh" type="number" step="0.1" placeholder="in">
          <label>Calf</label><input id="mCalf" type="number" step="0.1" placeholder="in">
          <label>Bicep</label><input id="mBicep" type="number" step="0.1" placeholder="in">
          <label>Forearm</label><input id="mFore" type="number" step="0.1" placeholder="in">
        </div>
      </div>
      <div>
        <h2>Where to Measure</h2>
        <div class="card">
          ${bodySVG()}
          <p class="small" style="margin-top:6px">
            • <b>Neck:</b> below Adam’s apple • <b>Chest:</b> nipple line • <b>Waist:</b> narrowest torso • <b>Hips:</b> widest butt/hip •
            <b>Thigh:</b> 6–8" above knee • <b>Calf:</b> widest girth • <b>Bicep/Forearm:</b> widest point, arm relaxed.
          </p>
        </div>
      </div>
    </section>
    <section class="panel"><h2>History</h2><div id="mList" class="list"></div></section>
  `;

  $("#saveM").onclick=()=>{
    const rec={date:$("#mDate").value||todayISO(), neck:+($("#mNeck").value||0), chest:+($("#mChest").value||0), waist:+($("#mWaist").value||0), hips:+($("#mHips").value||0), thigh:+($("#mThigh").value||0), calf:+($("#mCalf").value||0), bicep:+($("#mBicep").value||0), forearm:+($("#mFore").value||0)};
    const arr=ls("measurements")||[]; const i=arr.findIndex(x=>x.date===rec.date); if(i>=0) arr[i]=rec; else arr.push(rec);
    arr.sort((a,b)=>a.date.localeCompare(b.date)); ls("measurements",arr); render();
    alert("Saved ✅");
  };

  function render(){
    const arr=(ls("measurements")||[]).sort((a,b)=>a.date.localeCompare(b.date));
    const list=$("#mList"); list.innerHTML="";
    if(!arr.length){ list.innerHTML=`<div class="item">No measurements yet.</div>`; return; }
    arr.forEach(r=>{
      const el=document.createElement("div"); el.className="item";
      el.innerHTML = `<strong>${r.date}</strong><div class="small">Neck ${r.neck}" • Chest ${r.chest}" • Waist ${r.waist}" • Hips ${r.hips}" • Thigh ${r.thigh}" • Calf ${r.calf}" • Bicep ${r.bicep}" • Forearm ${r.forearm}"</div>`;
      list.append(el);
    });
  }
  function bodySVG(){
    return `
  <svg viewBox="0 0 240 360" width="100%" xmlns="http://www.w3.org/2000/svg" style="background:#0e1622;border:1px solid var(--border);border-radius:10px">
    <g fill="none" stroke="#c3d1dc" stroke-width="2">
      <circle cx="120" cy="26" r="12"/>
      <path d="M120 38 q-20 10 -22 32 q-4 25 -12 40 q-10 18 -10 40 v60 q0 40 14 70 q10 20 30 30 q20 -10 30 -30 q14 -30 14 -70 v-60 q0 -22 -10 -40 q-8 -15 -12 -40 q-2 -22 -22 -32" />
    </g>
    <g stroke="#2ea043" stroke-width="3">
      <line x1="60" y1="58" x2="180" y2="58"/>
      <line x1="40" y1="102" x2="200" y2="102"/>
      <line x1="55" y1="148" x2="185" y2="148"/>
      <line x1="40" y1="190" x2="200" y2="190"/>
      <line x1="28" y1="252" x2="98" y2="252"/>
      <line x1="142" y1="252" x2="212" y2="252"/>
      <line x1="35" y1="300" x2="95" y2="300"/>
      <line x1="145" y1="300" x2="205" y2="300"/>
      <line x1="20" y1="136" x2="70" y2="136"/>
      <line x1="170" y1="136" x2="220" y2="136"/>
      <line x1="16" y1="162" x2="66" y2="162"/>
      <line x1="174" y1="162" x2="224" y2="162"/>
    </g>
    <g fill="#e8eef5" font-size="12" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial">
      <text x="184" y="56">Neck</text>
      <text x="204" y="100">Chest</text>
      <text x="190" y="146">Waist</text>
      <text x="204" y="188">Hips</text>
      <text x="12"  y="134">Bicep</text>
      <text x="224" y="134" text-anchor="end">Bicep</text>
      <text x="10"  y="160">Forearm</text>
      <text x="226" y="160" text-anchor="end">Forearm</text>
      <text x="22"  y="250">Thigh</text>
      <text x="218" y="250" text-anchor="end">Thigh</text>
      <text x="20"  y="298">Calf</text>
      <text x="220" y="298" text-anchor="end">Calf</text>
    </g>
  </svg>`;
  }
  render();
 },

 /* ---------- NOTES ---------- */
 notes(){
   view.innerHTML = `
    <section class="panel"><h2>Notes</h2>
      <div class="row"><input id="nDate" type="date" value="${todayISO()}"></div>
      <textarea id="nText" rows="4" placeholder="Write your note…"></textarea>
      <div style="height:8px"></div>
      <button class="btn" id="saveN">Save Note</button>
    </section>
    <section class="panel"><h2>History</h2><div id="nList" class="list"></div></section>
   `;
   $("#saveN").onclick=()=>{
     const arr=ls("notes")||[]; const rec={date:$("#nDate").value||todayISO(), text:$("#nText").value||""};
     const i=arr.findIndex(x=>x.date===rec.date); if(i>=0) arr[i]=rec; else arr.unshift(rec);
     ls("notes",arr); render(); alert("Saved ✅");
   };
   function render(){
     const arr=(ls("notes")||[]); const list=$("#nList"); list.innerHTML="";
     if(!arr.length){ list.innerHTML=`<div class="item">No notes yet.</div>`; return; }
     arr.forEach((r,idx)=>{
       const el=document.createElement("div"); el.className="item";
       el.innerHTML=`<div class="row" style="align-items:start"><strong style="min-width:110px">${r.date}</strong><div style="flex:1;white-space:pre-wrap">${r.text}</div><button class="btn btn-ghost" data-del="${idx}">Delete</button></div>`;
       list.append(el);
     });
     list.querySelectorAll("[data-del]").forEach(b=>b.onclick=()=>{ const arr=ls("notes")||[]; arr.splice(+b.dataset.del,1); ls("notes",arr); render(); });
   }
   render();
 },

 /* ---------- 1-MILE TEST ---------- */
 test(){
  view.innerHTML = `
   <section class="panel"><h2>1-Mile Walk Test</h2>
     <div class="row"><button class="btn" id="start">Start</button><button class="btn" id="stop">Stop</button></div>
     <h2 id="timer">0:00</h2>
   </section>
   <section class="panel"><h2>Results</h2><div id="results" class="list"></div></section>`;
  const tEl=$("#timer");
  let t=null, start=0;
  const fmt = ms => { const s=Math.floor(ms/1000), m=Math.floor(s/60), ss=String(s%60).padStart(2,"0"); return `${m}:${ss}`; };
  $("#start").onclick=()=>{ if(t) clearInterval(t); start=Date.now(); t=setInterval(()=>{ tEl.textContent=fmt(Date.now()-start); },250); };
  $("#stop").onclick=()=>{ if(!t) return; clearInterval(t); const ms=Date.now()-start;
    const rec={date: todayISO(), timeSec: Math.floor(ms/1000)};
    const tests=ls("mileTests")||[]; tests.push(rec); ls("mileTests", tests);
    renderResults(); alert("Saved ✅");
  };
  function renderResults(){
    const list = $("#results"); list.innerHTML="";
    const tests=(ls("mileTests")||[]).sort((a,b)=>a.date.localeCompare(b.date));
    tests.forEach(r=>{ const m=Math.floor(r.timeSec/60), s=String(r.timeSec%60).padStart(2,"0");
      list.innerHTML += `<div class="item"><strong>${r.date}</strong> — ${m}:${s}</div>`;
    });
  }
  renderResults();
 },

 /* ---------- SETTINGS ---------- */
 settings(){
  const s = ls("settings")||{kcal:2400,protein:180};
  const start = ls("startDateISO");
  view.innerHTML = `
    <section class="panel"><h2>Settings</h2>
      <div class="kv">
        <label>Plan start date</label><input id="startDate" type="date" />
        <label>Calories target</label><input id="kcal" type="number" placeholder="e.g., 2400" value="${s.kcal||2400}" />
        <label>Protein target (g)</label><input id="protein" type="number" placeholder="e.g., 180" value="${s.protein||180}" />
      </div>
      <div style="height:12px"></div>
      <button class="btn" id="save">Save</button>
      <p class="small" style="margin-top:8px">Data is stored locally on this device (no accounts).</p>
      <div style="height:12px"></div>
      <div class="row">
        <button class="btn" id="exportBtn">Export Data</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button class="btn" id="importBtn">Import Data</button>
      </div>
    </section>`;
  if (start) $("#startDate").value = start.slice(0,10);
  $("#save").onclick=()=>{
    const d=$("#startDate").value; if(d) ls("startDateISO", new Date(d).toISOString());
    const kcal=+($("#kcal").value||0), protein=+($("#protein").value||0);
    ls("settings",{kcal,protein}); alert("Saved ✅");
  };

  $("#exportBtn").onclick = ()=>{
    const dump = {
      log: ls("log")||[],
      mileTests: ls("mileTests")||[],
      foodLog: ls("foodLog")||{},
      settings: ls("settings")||{},
      startDateISO: ls("startDateISO")||null,
      weights: ls("weights")||[],
      startWeight: ls("startWeight")||null,
      measurements: ls("measurements")||[],
      notes: ls("notes")||[]
    };
    const blob = new Blob([JSON.stringify(dump,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `justin-workout-backup-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
  };

  $("#importBtn").onclick = ()=> $("#importFile").click();
  $("#importFile").onchange = async (e)=>{
    const file = e.target.files[0]; if (!file) return;
    const text = await file.text();
    try {
      const data = JSON.parse(text);
      ["log","mileTests","foodLog","settings","startDateISO","weights","startWeight","measurements","notes"].forEach(k=>{
        if (data[k]!==undefined) ls(k, data[k]);
      });
      alert("Import complete ✅  (Reopen tabs to see updates)");
    } catch(e){ alert("Import failed: invalid file"); }
  };
 }
};

/* ===================== ROUTER ===================== */
function switchView(k){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.view===k));
  (VIEWS[k]||VIEWS.home)();
}
const tabsEl = document.getElementById('tabs');
tabsEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('.tab');
  if (!btn || !tabsEl.contains(btn)) return;
  switchView(btn.dataset.view);
});
switchView('home');

/* ===================== INLINE MANIFEST & SW ===================== */
const manifest = { name:"Justin Workout", short_name:"Workout", start_url:".", display:"standalone",
  background_color:"#0c0f15", theme_color:"#131a24", icons:[] };
const blob = new Blob([JSON.stringify(manifest)], {type: "application/manifest+json"});
const murl = URL.createObjectURL(blob);
const link = document.createElement('link'); link.rel='manifest'; link.href=murl; document.head.appendChild(link);

// bump CACHE to force update if needed
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE='jw-onefile-v6';
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch', e=>{
      if(e.request.method!=='GET') return;
      e.respondWith(caches.match(e.request).then(cached=>cached||fetch(e.request).then(res=>{
        const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res;
      }).catch(()=>cached||caches.match('./'))));
    });
  `;
  const swBlob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  window.addEventListener('load', ()=>navigator.serviceWorker.register(swUrl));
}
</script>
</body>
</html>
